<html>
  <body>
    <button onclick="textInterop()">Text Interop</button>
    <button onclick="listRendering()">List Rendering</button>

    <p id="benchmark-output"></p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/platform/1.3.6/platform.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/benchmark/2.1.4/benchmark.min.js"></script>

    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
    <script src="https://unpkg.com/vue@next"></script>
    <script src="../dist/lucia.js"></script>

    <script>
      const wrap = (el) => {
        const wrapper = document.createElement('div');
        wrapper.appendChild(el);
        return wrapper;
      };

      const createLuciaApp = (inside, state) => {
        const app = document.createElement('div');
        app.setAttribute('l-state', state);
        app.innerHTML = inside;
        app.hidden = true;
        app.id = 'lucia';
        return wrap(app);
      };

      const createJSApp = (inside) => {
        const app = document.createElement('div');
        app.innerHTML = inside;
        return wrap(app);
      };

      const createVueApp = (inside, state) => {
        const app = document.createElement('div');
        app.setAttribute('id', 'app');
        app.innerHTML = inside;
        return wrap(app);
      };

      const createAlpineApp = (inside, state) => {
        const app = document.createElement('div');
        app.setAttribute('x-data', state);
        app.innerHTML = inside;
        app.hidden = true;
        app.id = 'alpine';
        return wrap(app);
      };

      const textInterop = () => {
        console.log('Starting Text Interpolation');

        const suite = new Benchmark.Suite();
        const luciaEl = createLuciaApp(
          `
          <p>{{ c }}</p>
        `,
          '{ c: "" }'
        );
        const vueEl = createVueApp(
          `
          <p>{{ c }}</p>
        `,
          { c: '' }
        );
        const jsEl = createJSApp('<p></p>');
        const alpineEl = createAlpineApp(
          `
          <p x-text="c"></p>
        `,
          '{ c: "" }'
        );

        Lucia.init(luciaEl);

        const vueApp = Vue.createApp({
          data() {
            return { c: '' };
          },
        }).mount(vueEl.querySelector('#app'));

        const jsApp = jsEl.querySelector('div > p');
        document.body.appendChild(alpineEl);
        document.body.appendChild(luciaEl);

        setTimeout(() => {
          const alpineApp = document.querySelector('#alpine').__x;
          const luciaApp = document.querySelector('#lucia').__l;

          alpineApp.$data.arr = [];

          const fn = (state) => new Function(['$'], 'return this.a')({ a: 1 });
          const fnNone = (string) => new Function(string);

          suite
            // .add('new Function', () => {
            //   const val = 1;
            //   fnNone(`return &.a`.replace('&.a', val))();
            // })
            // .add('new Function with state', () => {
            //   fn({ a: 1 });
            // })
            .add('JavaScript', () => {
              const c = Date.now();
              jsApp.textContent = c + c;
            })
            .add('Lucia', () => {
              luciaApp.state.c = Date.now();
            })
            .add('Vue', () => {
              vueApp.$data.c = Date.now();
            })
            // .add('Alpine', () => {
            //   alpineApp.$data.c = Date.now();
            // })
            .on('cycle', (event) => {
              document.querySelector('#benchmark-output').innerText += `${String(event.target)}\n`;
            })
            .on('complete', () => {
              document.querySelector('#benchmark-output').innerText += `Fastest: ${suite
                .filter('fastest')
                .map('name')}\n`;
            })
            .run({ async: true, maxTime: 1 });
        }, 0);
      };

      const listRendering = () => {
        console.log('Starting List Rendering');

        const suite = new Benchmark.Suite();
        const luciaEl = createLuciaApp(
          `
          <ul l-for="i in this.arr">
            <li l-text="this.i"></li>
          </ul>
        `,
          '{ arr: [] }'
        );
        const vueEl = createVueApp(
          `
          <ul v-for="i in arr">
            <li>{{ i }}</li>
          </ul>
        `,
          { arr: [] }
        );
        const jsEl = createJSApp('<ul></ul>');
        const alpineEl = createAlpineApp(
          `
          <template x-for="i in arr">
            <li x-text="i"></li>
          </template>
        `,
          '{ arr: [] }'
        );

        Lucia.init(luciaEl);

        const vueApp = Vue.createApp({
          data() {
            return { arr: [] };
          },
        }).mount(vueEl.querySelector('#app'));

        const jsApp = jsEl.querySelector('div > ul');
        const luciaApp = luciaEl.querySelector('div').__l;
        document.body.appendChild(alpineEl);

        setTimeout(() => {
          const alpineApp = document.querySelector('body > div > div').__x;

          alpineApp.$data.arr = [];

          suite
            .add('JavaScript', () => {
              const li = document.createElement('li');
              li.textContent = 0;
              jsApp.appendChild(li);
            })
            .add('Lucia', () => {
              luciaApp.state.arr.push(0);
            })
            .add('Vue', () => {
              vueApp.$data.arr.push(0);
            })
            .add('Alpine', () => {
              alpineApp.$data.arr.push(0);
            })
            .on('cycle', (event) => {
              document.querySelector('#benchmark-output').innerText += `${String(event.target)}\n`;
            })
            .on('complete', () => {
              document.querySelector('#benchmark-output').innerText += `Fastest: ${suite
                .filter('fastest')
                .map('name')}\n`;
            })
            .run({ async: true, maxTime: 1 });
        }, 0);
      };
    </script>
  </body>
</html>
